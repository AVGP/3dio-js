<!DOCTYPE html>
<html>
  <head>
    <title>3dio for Aframe</title>
    <!-- aframe library -->
    <script src="https://aframe.io/releases/0.6.1/aframe.min.js"></script>
    <script src="../../../build/3dio.js"></script>
    <style>
      .btn {
        position: absolute;
        top: 20px;
        left: 20px;
        border: solid 2px black;
        outline: none;
        background: transparent;
        color: black;
        font-weight: bold;
        font-size: 20px;
        letter-spacing: 1px;
        padding: 5px 15px;
        cursor: pointer;
        z-index: 1000;
      }
      .btn:hover {
        background: #222;
        color: white;
      }
    </style>
  </head>
  <!-- start the body of your page -->
  <body>
    <!-- Define your 3d scene and enabled ar.js -->
    <button class="btn">furnish</button>
    <a-scene vr-mode-ui="enabled: false">
      <a-camera position="0 5 5"></a-camera>
      <a-entity id="cursor" cursor="rayOrigin: mouse"></a-entity>
      <a-image id="floor-plan" width="13.98" height="16.15" src="https://storage.3d.io/132f8fd0-f7e0-432a-ad21-732f3307e77e/2017-08-31_21-55-19_xExGmY/Grundriss_WE17_s.jpg" rotation="-90 0 0"></a-image>
    </a-scene>
    <script>
      io3d.config({
        // use https://spaces.archilogic.com/api/v2 in production
        servicesUrl: 'https://testing.archilogic.com/api/v2',
        publishableApiKey: '213edd35-0500-4953-bbc1-b4d7535d604f'
      })
      let cursor = document.querySelector('#cursor')
      let btn = document.querySelector('.btn')
      var sceneEl = document.querySelector('a-scene')
      // bind events
      cursor.addEventListener('click', elementClick)
      btn.addEventListener('click', furnish)
      var addedItems = []

      function furnish() {
        // let's show some status messages
        var msgRecogntionStart, msgStagingStart
        msgRecogntionStart = io3d.utils.ui.message('start recognition')

        // floor plan recognition call
        io3d.floorPlan.recognize('#floor-plan')
          .then(sceneStructure => {
            // update ui messages
            msgRecogntionStart.close()
            msgStagingStart = io3d.utils.ui.message('start home staging')

            // get home staging furnishings
            return io3d.staging.getFurnishings(sceneStructure)
          })
          .then(results => {
            msgStagingStart.close()
            io3d.utils.ui.message('home staging finished')

            // convert sceneStructure to aframe Html so we can place it in the scene
            var elements = io3d.scene.getHtmlFromSceneStructure(results)
            // check for previously added elements
            addedItems.forEach(el => {
              el.parentNode.removeChild(el)
            })
            // add elements to the scene
            elements.forEach(el => {
              sceneEl.appendChild(el)
            })
            addedItems = elements
          })
          .catch(function(error) {
            console.error('something went wrong', error)
          })
      }
      function elementClick() {
        let el = cursor.components.raycaster.intersectedEls[0]
        let furniture = el.getAttribute('io3d-furniture')
        if (furniture) {
          io3d.staging.replaceFurniture({id: furniture.id, position: el.getAttribute('position'), rotation: el.getAttribute('rotation')})
            .then(result => {
              if (!result) return
              let newEL = result[Math.floor(Math.random() * result.length)]
              el.setAttribute('io3d-furniture', {id: newEL.furniture.id})
              el.setAttribute('position', AFRAME.utils.coordinates.stringify(newEL.position))
            })
        }
      }
    </script>
  </body>
</html>